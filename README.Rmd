---
output:
  github_document
---

# emoncmsr

Tools to work with the emonCMS API.

- emonCMS: https://openenergymonitor.org/

## Installation
```{r eval=FALSE}
devtools::install_github("davidski/emoncmsr")
```

## Usage

* Set environment variables
    * EMONCMS_URI - Full URL (w/final slash) to API endpoint
    * EMONCMS_API_KEY - API key value (read or write) to API
    
## Applications

Woring with inputs

```{r inputs_and_feeds}
library(emoncmsr)
suppressPackageStartupMessages(library(tidyverse))

# Inputs
list_inputs()
# create some beverage data
dat <- list(coffee = 42, tea = 6, water = 42)
post_data_to_input(dat)
list_inputs() %>% filter(nodeid == "emoncmsr", name == "coffee")
# store the id of the new input
inputid <- list_inputs() %>% filter(nodeid == "emoncmsr", name == "coffee") %>% pull(id)
inputid

# set a friendly description for our new input
set_input_field(inputid, "description", "cups of coffee remaining in pot")
list_inputs() %>% filter(id == inputid)

# Create feeds for one of our new inputs
feed_response <- create_feed("coffeelevel", "emoncmsr")
feed_response
list_feeds() %>% filter(id == feed_response$feedid)

# Hook up the coffee monitor to the feed
set_input_process(inputid, paste(1, feed_response$feedid, sep = ":"))
get_input_processes(inputid)

# Post new data to all three new inputs
dat <- list(coffee = 86, tea = 100, water = 4)
post_data_to_input(dat)

# We can also use the bulk data input format for sending a dataframe 
# worth of data, all at differnet offsets to an optional timestamp
dat <- tibble::tribble(~offset, ~nodeid, ~value,
               -100, "emoncmsr", list(coffee = 100),
               -50, "emoncmsr", list(tea = 50),
               -10, "emoncmsr", list(water = 10))
post_bulk_data_to_input(dat)

# show the values we just posted appeared in the input
list_inputs() %>% filter(nodeid == "emoncmsr")

# we can also post with a specific reference time
reference_time <- lubridate::as_datetime("2017-03-27 01:30:00") %>% as.integer()
post_bulk_data_to_input(dat, reference_time)

# show the logged input made it to our new feed
get_feed_values(feed_response$feedid)
```

Deleteing feeds and inputs
```{r clean_up}
list_feeds() %>% filter(tag == "emoncmsr") %>% pull(id) %>% 
                          map(~ delete_feed(.x))
list_inputs() %>% filter(nodeid == "emoncmsr") %>% pull(id) %>% 
                           map(~ delete_input(.x))
```

Retrieving and plotting feed data
```{r plotting_feed_data}
dat <- get_feed_data(1)
gg <- ggplot(dat, aes(x = date, y = value)) + 
  geom_line() + geom_smooth(method = 'loess') +
  labs(title = "Power Usage", 
       subtitle = "Seven day historical with smoothed overlay",
       caption = "Demonstration plot for emoncmsr",
       y = "Watts", 
       x = NULL) +
  scale_y_continuous(labels = scales::comma) +
  theme_minimal()
gg
```

## Test results

```{r}
library(emoncmsr)
library(testthat)

date()

test_dir("tests/")
```

# Contributing

This project is governed by a [Code of Conduct](./CODE_OF_CONDUCT.md). By 
participating in this project you agree to abide by these terms.

# License

The [MIT License](LICENSE) applies.
